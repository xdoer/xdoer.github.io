<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />

<title>å†™ä¸€ä¸ªå€’è®¡æ—¶ğŸ˜¢ï¼Ÿ |
    æ–‡äº«æ—¥å¿—</title>
<meta name="description" content="" />

<meta
  name="viewport"
  content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"
/>
<link
  rel="shortcut icon"
  href="https://aiyou.life/favicon.ico?v=1645631653598"
/>

<link
  rel="stylesheet"
  href="https://use.fontawesome.com/releases/v5.7.2/css/all.css"
  integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
  crossorigin="anonymous"
/>
<link
  rel="stylesheet"
  href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css"
/>
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css"
/>
<link rel="stylesheet" href="https://aiyou.life/styles/main.css" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/themes/prism.css"
/>



<link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  
<!-- <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script> -->

<style>
  .prev-mask {
    display: none;
    position: fixed;
    width: 100%;
    height: 100%;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background-color: rgba(0, 0, 0, 0.6);
    z-index: 10000;
    justify-content: center;
    align-items: center;
  }
  .img-big {
    max-height: 70vh;
  }
  .post-content img {
    max-height: 500px;
  }
</style>

<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
    <div class="prev-mask">
      <div class="img-container">
        <div class="img-close">
          <img class="img-big" />
        </div>
      </div>
    </div>

    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://aiyou.life">æ–‡äº«æ—¥å¿—</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                é¦–é¡µ
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                å½’æ¡£
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                æ ‡ç­¾
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                å…³äº
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>å†™ä¸€ä¸ªå€’è®¡æ—¶ğŸ˜¢ï¼Ÿ</h1>
            <p class="article-meta">
              2021-06-01 
              <a
                href="https://aiyou.life/tag/K1r5vpFd_/"
                class="badge secondary"
              >
                å‰ç«¯
              </a>
              
            </p>
            
            <div class="post-content"><p>å¦‚ä½•å†™ä¸€ä¸ªé«˜æ€§èƒ½ã€æ˜“æ‰©å±•ã€æ˜“ç”¨çš„è®¡æ—¶å™¨ï¼Ÿ</p>
<!-- more -->
<p>æŸæ—¥ï¼Œæ¥åˆ°äº†äº§å“éœ€æ±‚ï¼Œè¯´è¦åŠ ä¸€ä¸ªæŠ¢è´­åˆ—è¡¨é¡µé¢ï¼Œåˆ—è¡¨ä¸­æ¯ä¸€é¡¹è¦åŠ ä¸€ä¸ªæŠ¢è´­å€’è®¡æ—¶ï¼Œæ²¡å¤šæƒ³ï¼Œä½¿ç”¨ <code>setInterval</code> å¿«é€Ÿå®ç°äº†ã€‚</p>
<p>éšç€åˆ—è¡¨ä¸­é¡¹ç›®è¶Šæ¥è¶Šå¤šï¼Œå„ä¸ªé¡¹ç›®çš„å€’è®¡æ—¶è¶Šæ¥è¶Šä¸å‡†ï¼Œä¸”é¡µé¢å˜çš„è¶Šæ¥è¶Šå¡ã€‚</p>
<p>å…¶å®å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œn å¤šä¸ª <code>setInterval</code> å®ä¾‹åŒæ—¶è¿è¡Œï¼Œé˜»å¡äº† JS çº¿ç¨‹ï¼Œå¯¼è‡´é¡µé¢è¶Šæ¥è¶Šå¡ï¼Œè®¡æ—¶å™¨è®¡æ—¶å‡ºç°äº†åå·®ã€‚æœ‰æ²¡æœ‰åŠæ³•ç”¨ä¸€ä¸ª <code>setInterval</code> å®ä¾‹ï¼Œè¿›è¡Œå¤šä¸ªå€’è®¡æ—¶å‘¢?</p>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹ <code>setInterval</code> ç”¨æ³•:</p>
<pre><code class="language-js">setInterval(() =&gt; {
    // callback
}, 1000)
</code></pre>
<p>å¦‚æœåœ¨ <code>setInterval</code> ä¸­æ‰§è¡Œå¤šä¸ªå›è°ƒå‡½æ•°ï¼Œé‚£ä¹ˆå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>ç®€å•å®ç°ä¸€ä¸‹:</p>
<pre><code class="language-js">class Timer {
    private timerId
    private cbs = []
    private cbId = 0

    constructor(delay) {
        this.delay = delay
    }

    private start() {
        this.timerId = setInterval(() =&gt; {
            this.cbs.forEach(item =&gt; {
                item.cb()
            })
        }, this.delay)
    }

    private stop() {
        clearInterval(this.timerId)
    }

    add(cb) {
        const id = this.cbId++
        this.cbs.push({ cb, id })
        if(!this.timerId) this.start()
        return id
    }

    remove(cbId) {
        const cbIdx = this.cbs.findIndex(({ id }) =&gt; id === cbId)
        this.cbs.splice(cbIdx, 1)
        if(!this.cbs.length) this.stop()
    }
}
</code></pre>
<p>é—®é¢˜åˆæ¥äº†ï¼Œä¸åŒçš„å›è°ƒå‡½æ•°ï¼Œå¯èƒ½éœ€è¦ä¸åŒçš„è®¡æ—¶é—´éš”ï¼Œè¿™æ€ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<p>å¯ä»¥é€šè¿‡ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®¡ç®— <code>setInterval</code> çš„æ‰§è¡Œæ¬¡æ•°ï¼Œæ‰§è¡Œæ¬¡æ•° * é—´éš”æ—¶é—´å°±æ˜¯æ‰§è¡Œæ€»æ—¶é—´ï¼Œæœ‰äº†æ‰§è¡Œæ€»æ—¶é—´å°±å¥½åŠäº†ï¼Œåªéœ€è¦è¿›è¡Œä½™è¿ç®—å³å¯ã€‚</p>
<p>é¦–å…ˆè®¾è®¡ cb å¯¹è±¡æ•°æ®ç»“æ„</p>
<pre><code class="language-js">interface CallBack {
    id: number   // å›è°ƒ id
    cb: () =&gt; any   // å›è°ƒå‡½æ•°
    interval: number    // æ‰§è¡Œå›è°ƒé—´éš”
}
</code></pre>
<p>å†æ¥å®ç°demo:</p>
<pre><code class="language-js">// some code
let count = 0
let delay = 1000
let cbs: CallBack[] = []
 setInterval(() =&gt; {
    cbs.forEach(({ cb, interval }) =&gt; {
        if(!(count * delay % interval)) {
            cb()
        }
    })
}, delay)
// some code
</code></pre>
<p>ä¸Šé¢ demo ä¸­å†™æ­»äº†æ‰§è¡Œé—´éš”ä¸º 1000msï¼Œé‚£å¯¹äºæ³¨å†Œäº† 500ms æ‰§è¡Œçš„å›è°ƒå‡½æ•°æ¥è®²ï¼Œä¼šå»¶è¿Ÿ 500ms åæ‰æ‰§è¡Œã€‚æˆ‘ä»¬å¯ä»¥éå†æ‰€æœ‰ cbsï¼Œä»ä¸­è·å–æœ€å°çš„ interval å½“åš delay å³å¯ã€‚</p>
<pre><code class="language-js">// some code
const min = this.cbs[0].interval
const delay = this.cbs.reduce((min, cur) =&gt;  cur.interval &lt; min ? cur.interval : min,min)
// some code
</code></pre>
<p>ä½¿ç”¨æ—¶ï¼Œåªéœ€è¦ new ä¸€ä¸ª Timer å®ä¾‹ï¼Œåœ¨éœ€è¦å€’è®¡æ—¶çš„åœ°æ–¹ï¼Œé€šè¿‡ add æ·»åŠ å›è°ƒå‡½æ•°å³å¯è‡ªåŠ¨å¯åŠ¨è®¡æ—¶å™¨ï¼Œåˆ é™¤æ—¶ï¼Œè°ƒç”¨ remove æ–¹æ³•ï¼Œåˆ é™¤å®Œæ‰€æœ‰æ³¨å†Œçš„å›è°ƒå‡½æ•°ï¼Œè®¡æ—¶å™¨è‡ªåŠ¨åœæ­¢ã€‚</p>
<pre><code class="language-js">const timer = new Timer()

const timerId = timer.add(() =&gt; {}, 1000)
timer.remove(timerId)
</code></pre>
<p>æˆ–è€…å†æ”¹é€ ä¸€ä¸‹ï¼Œå®ç°ç±»ä¼¼ <code>setTimeout</code> å’Œ <code>setInterval</code> çš„è°ƒç”¨æ–¹å¼</p>
<pre><code class="language-js">const setTimeoutInterval = timer.add.bind(timer)
const clearTimeoutInterval = timer.remove.bind(timer)
</code></pre>
<p>è°ƒç”¨</p>
<pre><code class="language-js">const timer = setTimeoutInterval(() =&gt; {
    // some code
})

clearTimeoutInterval(timerId)
</code></pre>
<p>æ”¹é€ åçš„å€’è®¡æ—¶æ€§èƒ½æ— ç–‘å¥½äº†è®¸å¤šï¼Œé¡µé¢ä¸å†å¡é¡¿ã€‚ä¸”æ— è®ºæ·»åŠ å¤šå°‘ä¸ªè®¡æ—¶å›è°ƒï¼Œå®ƒè¿è¡Œçš„éƒ½æ˜¯åŒä¸€ä¸ªè®¡æ—¶å®ä¾‹ã€‚</p>
<p>ä½¿ç”¨ <code>setInterval</code> çš„è®¡æ—¶è¿˜æ˜¯è¶Šæ¥è¶Šä¸å‡†ï¼Œ<code>setInterval</code> ä¼šå°†å›è°ƒå‡½æ•°é—´éš”æ’å…¥ JS çº¿ç¨‹ä¸­ï¼Œä½†çº¿ç¨‹å¦‚æœæ­£åœ¨æ‰§è¡Œè€—æ—¶ä»»åŠ¡ï¼Œæ’å…¥çš„å›è°ƒå‡½æ•°å°†åç§»å…¶åº”å½“åœ¨çš„ä½ç½®ï¼Œæ»åæ‰§è¡Œï¼Œä¸‹ä¸€æ¬¡æ’å…¥çš„ä½ç½®ï¼Œå‚ç…§äº†æ»åæ’å…¥çš„ä½ç½®ï¼Œæ‰€ä»¥å¯¼è‡´è¿è¡Œæ—¶é—´è¶Šé•¿ï¼Œåå·®è¶Šå¤§ã€‚</p>
<p>ä½¿ç”¨é€’å½’ <code>setTimeout</code> ï¼Œä¸æ–­ä¿®æ­£å°†å›è°ƒå‡½æ•°æ’å…¥çº¿ç¨‹çš„æ—¶é—´ï¼Œå³å¯è·å¾—ç›¸å¯¹å‡†ç¡®çš„å€’è®¡æ—¶ã€‚</p>
<p>ç®€å•å®ç°ä¸€ä¸‹:</p>
<pre><code class="language-js">let count = 0 // é€’å½’æ¬¡æ•°
let now = Date.now() // åˆå§‹æ‰§è¡Œæ—¶é—´

function countdown() {
    const offset = Date.now() - (now + count * 1000)
    const nextTime = 1000 - offset
    count++

    setTimeout(() =&gt; {
        countdown()
    }, nextTime)
}
countdown()
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬è®°å½•äº†åˆå§‹æ‰§è¡Œæ—¶é—´ï¼Œå’Œ countdown é€’å½’æ‰§è¡Œçš„æ¬¡æ•°ï¼Œæ ¹æ®è¿™ä¸¤è€…ï¼Œæˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºåç§»æ—¶é—´å’Œä¸‹æ¬¡ <code>setTimeout</code> çš„æ—¶é—´ã€‚</p>
<p>æ”¹é€ åï¼Œè™½ç„¶å€’è®¡æ—¶å‡†ç¡®äº†è®¸å¤šã€‚ä½†ï¼Œåˆå›åˆ°äº†ä¸Šé¢çš„é—®é¢˜ï¼Œåˆ—è¡¨é¡¹è¶Šå¤šï¼Œ <code>setTimeout</code> å®ä¾‹è¶Šå¤šï¼Œé¡µé¢ä¹Ÿä¼šè¶Šæ¥è¶Šå¡ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>setTimeout</code> æ¨¡æ‹Ÿ <code>setinterval</code>ï¼Œå¹¶å°†å…¶æ›¿æ¢åˆ°ä¸Šé¢æˆ‘ä»¬çš„ <code>Timer</code> ç±»ä¸­ã€‚å³å¯è§£å†³é—®é¢˜ã€‚</p>
<pre><code class="language-js">function timeoutInterval(cb, interval = 1000ï¼Œ getTimerId) {
  let count = 0
  let now = Date.now()
  let timerId = null

  function countdown() {
    const offset = Date.now() - (now + count * interval)
    const nextTime = interval - offset
    count++

    timerId = setTimeout(() =&gt; {
      countdown()
      cb()
    }, nextTime)

    getTimerId(timerId)
  }

  countdown()
}
</code></pre>
<p>è¿™é‡Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºæˆ‘ä»¬è¿™é‡Œä½¿ç”¨é€’å½’ <code>setTimeout</code>, æ‰€ä»¥æ¯æ¬¡ç”Ÿæˆçš„ <code>timeId</code> éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œæ‰€ä»¥è®¾è®¡å°†å…¶é€šè¿‡ <code>cb</code> å›è°ƒå‡½æ•°çš„å‚æ•°ä¼ å‡ºã€‚</p>
<p>ç”¨æ³•å¦‚ä¸‹:</p>
<pre><code class="language-js">let i = 0
timeoutInterval(
    () =&gt; {
    // do something
    }, 
    1000,
    (timerId) =&gt; {
        this.timerId = timerId
    }
)
</code></pre>
<p>å°†å…¶æ›¿æ¢åˆ° <code>Timer</code> ç±»ä¸­</p>
<pre><code class="language-js">class Timer {
    // some code
    private start() {
        timeoutInterval(
            () =&gt; {
                this.cbs.forEach(item =&gt; {
                    item.cb()
                })
            }, 
            1000,
            (timerId) =&gt; {
                this.timerId = timerId
            }
        )
    }
    // some code
}
</code></pre>
<p>æ”¹é€ åçš„å€’è®¡æ—¶æ€§èƒ½è‰¯å¥½ï¼Œä¸”å› ä¸ºåªæœ‰ä¸€ä¸ªè®¡æ—¶å®ä¾‹ï¼Œé¡µé¢ä¹Ÿä¸ä¼šå¡é¡¿ã€‚</p>
<p>å…·ä½“å®ç°è¯·æŸ¥é˜…ä»£ç : <a href="https://github.com/xdoer/TimeoutInterval">TimeoutInterval</a></p>
<p>å¯¹äºä¸€äº›ç§’æ€æŠ¢è´­åœºæ™¯ï¼Œè¿™ç§å€’è®¡æ—¶æ˜¯æœ‰é—®é¢˜çš„ï¼Œå› ä¸ºæœ¬åœ°æ—¶é—´ä¸æœåŠ¡å™¨æ—¶é—´æœ‰åå·®ï¼Œå¦‚æœæŠ¢è´­å•çº¯ç”±å‰ç«¯å€’è®¡æ—¶æ¥æ§åˆ¶ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å‡ºç°ç”¨æˆ·ä¿®æ”¹æœ¬æœºæ—¶é—´ï¼Œé¡µé¢å°±å‡ºç°äº†è´­ä¹°æŒ‰é’®å¯ä»¥ç›´æ¥è´­ä¹°çš„ bugã€‚ç”±æœ¬åœ°è®¡æ—¶å¼•èµ·çš„ bugï¼Œåœ¨ç›®å‰å¸‚é¢ä¸Šçš„ APP ä¸Šå¾ˆå¸¸è§ï¼Œé™¤äº†æŠ¢è´­åœºæ™¯å¤–ï¼Œæ¥å£é˜²é‡æ”¾æœºåˆ¶ä¸­ä¼šæ ¡éªŒå®¢æˆ·ç«¯è¯·æ±‚æºå¸¦çš„æ—¶é—´æˆ³ï¼Œé€šå¸¸çº¦å®šï¼Œå¦‚æœå®¢æˆ·ç«¯è¯·æ±‚çš„æ—¶é—´æˆ³ä¸æœåŠ¡ç«¯æ—¶é—´åå·®åœ¨ 60s ä¹‹å¤–ï¼Œåˆ™è¯¥è¯·æ±‚æ— æ•ˆï¼Œæ‰€ä»¥åœ¨ä¿®æ”¹æœ¬æœºæ—¶é—´åï¼Œæ‰“å¼€æŸäº› APPï¼Œä¼šçœ‹åˆ°ç©ºç™½é¡µé¢ã€‚</p>
<p>è§£å†³åŠæ³•å¾ˆç®€å•ã€‚</p>
<p>æ‰“å¼€åº”ç”¨åï¼Œé¦–å…ˆå°†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„åç§»æ—¶é—´å­˜åˆ°æœ¬åœ°ï¼Œç§’æ€å€’è®¡æ—¶çš„æ—¶å€™ï¼Œå°†åç§»æ—¶é—´åŠ ä¸Šå³å¯ã€‚è¿™æ ·çš„è¯ï¼Œæ— è®ºå®¢æˆ·ç«¯æ—¶é—´æ˜¯æå‰è¿˜æ˜¯ä¹‹åï¼Œéƒ½å¯¹åº”ç”¨æ²¡æœ‰å½±å“ã€‚</p>
<p>ç®€å•å†™ä¸ª demo:</p>
<pre><code class="language-js">// é¦–å…ˆè·å–åç§»æ—¶é—´
prequest('/api').then(res =&gt; {
    // nginx æœåŠ¡å™¨ï¼Œå¯ä»¥ä»å“åº”å¤´æ‹¿åˆ°æ—¶é—´
    const date = res.headers.Date
    const offsetTime = Date.now() - new Date(date).getTime()
    localStorage.setItem('offsetTime', offsetTime)
})

// å°è£…è·å–æ—¶é—´æ–¹æ³•
function getNow() {
    const offset = localStorage.getItem('offsetTime')
    return Date.now() + Number.parseInt(offset)
}
</code></pre>
<p>å›åˆ°æˆ‘ä»¬çš„è®¡æ—¶å™¨ä»£ç ï¼Œåªéœ€è¦å°†å…¶ä¸­çš„ <code>Date.now()</code> æ–¹æ³•æ›¿æ¢æˆ è¿™é‡Œçš„ <code>getNow()</code> å³å¯ã€‚</p>
<p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä¸Šé¢çš„ä»£ç å·²ç»å¯ä»¥åº”å¯¹å¤§éƒ¨åˆ†è®¡æ—¶åœºæ™¯ï¼Œä½†å¯¹äºç§’æ€åœºæ™¯æ¥è¯´ï¼Œæœ¬åœ°è¿è¡Œçš„å€’è®¡æ—¶å¯èƒ½è¿˜æ˜¯ä¸å¤Ÿå¯é ï¼Œå¯ä»¥è®¾è®¡é—´æ­‡æ€§è¯·æ±‚æ¥å£è·å–æœåŠ¡ç«¯æ—¶é—´ï¼Œæ›´æ–°å€’è®¡æ—¶ï¼Œæ¥è·å¾—æ›´é«˜è®¡æ—¶ç²¾ç¡®åº¦ã€‚</p>
<p>é¦–å…ˆå¤§è‡´è®¾è®¡è·å–æœåŠ¡ç«¯æ—¶é—´æ–¹æ³•</p>
<pre><code class="language-js">async function getServerTime() {
    const start = Date.now()    // å¼€å¯è¯·æ±‚æ—¶é—´
    const serverTime = await prequest('/api').then(res =&gt; ...)
    const endTime = Date.now()
    return serverTime + (endTime - startTime) / 2
}
</code></pre>
<p>è¿™é‡Œè€ƒè™‘äº†è¯·æ±‚ç½‘ç»œæ¶ˆè€—çš„æ—¶é—´ã€‚</p>
<p>å…¶æ¬¡è€ƒè™‘æˆ‘ä»¬å€’è®¡æ—¶ï¼Œå½“æ¯æ¬¡æ‹¿åˆ°æœåŠ¡ç«¯æ—¶é—´åï¼ŒåŠ ä¸Š <code>interval</code> æ—¶é—´ï¼Œåˆ¤æ–­æ˜¯å¦å’Œç›®æ ‡æ—¶é—´ç›¸ç­‰å³å¯ã€‚</p>
<p>demoå¦‚ä¸‹</p>
<pre><code class="language-js">let now = Date.now()
let interval = 1000
setInterval(() =&gt; {
    if (now + interval &gt;=  endTime) {
        // some code
    }
}, interval)

setInterval(() =&gt; {
    getServerTime(res).then(res =&gt; now = res)
}, 5000)
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬ç»´æŠ¤äº†ä¸¤ä¸ªè®¡æ—¶å™¨ï¼Œä¸€ä¸ªè´Ÿè´£è¯·æ±‚æ¥å£æ›´æ–° <code>now</code> æ•°æ®ï¼Œä¸€ä¸ªè¿›è¡Œæ­£å¸¸å€’è®¡æ—¶ï¼Œå†™æˆ‘ä»¬çš„ä¸šåŠ¡é€»è¾‘ã€‚</p>
<p>å½“æœ‰ n å¤šä¸ªè¿™æ ·çš„å€’è®¡æ—¶å®ä¾‹ï¼Œä»£ç å°†ä¸å¯ç»´æŠ¤ã€‚å¯ä»¥æ”¹é€ ä¸€ä¸‹ä»£ç ï¼Œä½¿ç”¨ç±»ä¼¼äº‹ä»¶å‘å¸ƒè®¢é˜…çš„æ¨¡å¼æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p>
<p>é¦–å…ˆå®ç°ä¸€ä¸ª <code>manager</code> æ¥å®ç°äº‹ä»¶å‘å¸ƒè®¢é˜…çš„é€»è¾‘</p>
<pre><code class="language-js">class CountDowmManager {
    queue = []
    tiemrId = null

    constructor({ getRemoteDate, interval }) {
        this.getRemoteDate = getRemoteDate
        this.interval = interval
    }

    private start() {
        this.timerId = timer.add(() =&gt; {
            this.getNow()
        }, this.interval)
    }

    private stop() {
        timer.remove(this.timerId)
    }

    on (countdown) {
        this.queue.push(countdown)
        if(!this.timerId) this.start()
    }

    off(countdown) {
        this.queue.splice(this.queue.findIndex(i =&gt; i === countdown), 1)
        if(!this.queue.length) this.stop()
    }

    private async getNow() {
        try {
            const start = Date.now()
            const nowStr = await this.opt.getRemoteDate()
            const end = Date.now()
            this.queue.forEach((instance) =&gt; (instance.now = new Date(nowStr).getTime() + (end - start) / 2)
        } catch (e) {
            console.log('fix time fail', e)
        }
    }
}
</code></pre>
<p>åœ¨ <code>CountDownManager</code> ç±»ä¸­ï¼Œç»´æŠ¤äº†ä¸€ä¸ª <code>countdown</code> å®ä¾‹çš„é˜Ÿåˆ—ï¼Œæ¯éš” <code>interval</code> ä¸ªæ—¶é—´ï¼Œä¼šè¯·æ±‚æ¥å£ï¼Œæ›´æ–°æ‰€æœ‰å®ä¾‹çš„ <code>now</code> å€¼ã€‚åŒæ—¶è®¾è®¡å°†è·å–æœåŠ¡å™¨æ—¶é—´çš„å‡½æ•°ç”±å‚æ•°ä¼ å…¥ï¼Œå·²æ»¡è¶³ä¸åŒåœºæ™¯çš„ä¸åŒéœ€æ±‚ã€‚</p>
<p>æ¥ç€ï¼Œè®¾è®¡å€’è®¡æ—¶</p>
<pre><code class="language-js">class CountDown {
    now = Date.now()
    timerId = null

   // ... some code
    start() {
        this.timerId = timer.add(() =&gt; {
            this.now += interval

            if (this.now &gt;= endTime) {
                // some code
                return
            }
        })
    }

    // some code
}
</code></pre>
<p>ç”¨æ³•å¦‚ä¸‹:</p>
<pre><code class="language-js">const manager = new CountDownManager()

const instance1 = new CountDown()
const instance2 = new CountDown()

manager.on(instance1) 
manager.on(instance2)
</code></pre>
<p>ä¸Šé¢çš„ <code>CounDown</code>  ä»£ç ä¸­ï¼Œåªè€ƒè™‘äº†ä½¿ç”¨ <code>server</code> æ›´æ–°æ—¶é—´çš„åœºæ™¯ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥å°†ä¸Šé¢ä½¿ç”¨æœ¬åœ°æ—¶é—´è¿›è¡Œçš„å€’è®¡æ—¶ï¼Œæ•´åˆåˆ° <code>countDown</code> ç±»ä¸­ã€‚å…¶æ¬¡ï¼Œå¯ä»¥è®¾è®¡å°† <code>manager</code> ä½œä¸ºå‚æ•°ï¼Œä¼ å…¥åˆ° <code>countdown</code> å®ä¾‹ï¼Œè¿™æ ·åšçš„å¥½å¤„åœ¨äºï¼Œæˆ‘ä»¬ä¸éœ€è¦æ‰‹åŠ¨çš„æ³¨å†Œå’Œç§»é™¤ <code>countdown</code> å®ä¾‹ï¼Œå°† <code>managr</code> å½“å‚æ•°ä¼ å…¥ï¼Œåœ¨åˆå§‹åŒ–å®ä¾‹æ—¶ï¼Œå°±å¯ä»¥è‡ªåŠ¨å°†å½“å‰å®ä¾‹æ³¨å†Œï¼›å½“å€’è®¡æ—¶ç»“æŸï¼Œè‡ªåŠ¨å°†å½“å‰å®ä¾‹ç§»é™¤ã€‚æˆ‘ä»¬è¿˜å¯ä»¥æ ¹æ®æ˜¯å¦ä¼ å…¥ <code>manager</code> æ¥åˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨æœåŠ¡ç«¯æ¥æ›´æ–°æ—¶é—´ã€‚</p>
<p>æ”¹é€ ä¸€ä¸‹ä»£ç </p>
<pre><code class="language-js">class CountDown() {

    constructor({ manager, ...opt }) {
        this.manager = manager
        manager ? this.useServerToCountDown(...opt) : this.useLocalToCountDown(...opt)
    }

    useServerToCountDown() {
        // ...some code
        this.manager.on(this)
    }

    // ...some code

    clear() {
        timer.clear(this.timer)
        if(this.manager) {
            this.manager.off(this)
        }
    }
}
</code></pre>
<p>è‡³æ­¤ï¼Œæˆ‘ä»¬å°±å®Œæˆäº†ä¸€ä¸ªé«˜æ€§èƒ½ï¼Œå¥½æ‰©å±•ï¼Œæ˜“ç”¨çš„è®¡æ—¶å™¨äº†ã€‚</p>
<p>å®Œæ•´ä»£ç è¯·æŸ¥é˜… <a href="https://github.com/xdoer/CountDown">CountDown</a></p>
</div>
          </article>
          <div class="simple-share">
            <a class="share-item" href="javascript:share.qzone()">QQç©ºé—´</a>
            <a class="share-item" href="javascript:share.weibo()">å¾®åš</a>
            <a class="share-item" href="javascript:share.facebook()"
              >Facebook</a
            >
            <a class="share-item" href="javascript:share.twitter()">Twitter</a>
          </div>
        </div>
        <div class="paper" data-aos="fade-in">
          
          <div class="next-post">
            <div class="next">
              ä¸‹ä¸€ç¯‡
            </div>
            <a href="https://aiyou.life/post/4XYWTWTx/">
              <h3 class="post-title">æƒ³åˆ°çš„ä¸€äº›å¾ˆå¥½çš„é¢è¯•é¢˜</h3>
            </a>
          </div>
          
        </div>
         
        <div class="paper" data-aos="fade-in">
          <div id="gitalk-container"></div>
        </div>
          
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img
      src="https://aiyou.life/images/avatar.png?v=1645631653598"
      class="no-responsive avatar"
    />
    <div class="text-muted"></div>
    <div class="social-container">
       
      <a href="https://github.com/xdoer" target="_blank">
        <i class="fab fa-github"></i>
      </a>
        
      <a href="https://twitter.com/xxdoer1" target="_blank">
        <i class="fab fa-twitter"></i>
      </a>
        
      <a href="https://weibo.com/u/7407806835" target="_blank">
        <i class="fab fa-weibo"></i>
      </a>
          
      <a href="https://www.facebook.com/xxdoer" target="_blank">
        <i class="fab fa-facebook"></i>
      </a>
       
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      æœ€æ–°æ–‡ç« 
    </div>
    <div class="row">
      <ul>
         
        <li>
          <a href="https://aiyou.life/post/WTBK_yMNR/">è´¦æœ¬å¼€å‘å°è®°</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/7Ta0APQTd/">è®©ç”Ÿæ´»äº•äº•æœ‰æ¡</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/Fjnj0JDZ5/">å¯Œæ–‡æœ¬ç¼–è¾‘å™¨è½¬ä¸ºå—æ§ç»„ä»¶çš„ä¸€ç§æ€è·¯</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/zPGtmQi-5/">TS çš„ä¸€äº›é«˜çº§ç±»å‹å†™æ³•</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/QqaRhC3Gf/">Restful-API çš„ä¸€ç§åŠ¨æ€ç”Ÿæˆæ•°æ®ç±»å‹çš„æ–¹æ³•</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/SV2erlm_4/">å‡ ä¸ªDemo çœ‹æ‡‚ ESM ä¸ CommonJS å·®å¼‚</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/UNWTwtWxa/">Taro è‡ªå®šä¹‰ showModal</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/iWhkaOqqO/">å†™ä¸€ä¸ªå€’è®¡æ—¶ğŸ˜¢ï¼Ÿ</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/4XYWTWTx/">æƒ³åˆ°çš„ä¸€äº›å¾ˆå¥½çš„é¢è¯•é¢˜</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/M4RcI3wfU/">ç”±å°è£…ä¸€ä¸ªè¯·æ±‚åº“æ‰€æƒ³åˆ°çš„</a>
        </li>
                                   
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      æ ‡ç­¾åˆ—è¡¨
    </div>
    <div class="row">
      
      <a
        href="https://aiyou.life/tag/df67loo-n/"
        class="badge success"
      >
        ç¬”è®°
      </a>
      
      <a
        href="https://aiyou.life/tag/K1r5vpFd_/"
        class="badge secondary"
      >
        å‰ç«¯
      </a>
      
      <a
        href="https://aiyou.life/tag/E75leUW9b/"
        class="badge warning"
      >
        typescript
      </a>
      
      <a
        href="https://aiyou.life/tag/rSf0tu2pz/"
        class="badge "
      >
        React
      </a>
      
      <a
        href="https://aiyou.life/tag/TfrzxMzWY/"
        class="badge secondary"
      >
        å°ç¨‹åº
      </a>
      
      <a
        href="https://aiyou.life/tag/TDgBvCzI8/"
        class="badge secondary"
      >
        javascript
      </a>
      
      <a
        href="https://aiyou.life/tag/g_6wyy_ol/"
        class="badge success"
      >
        ç½‘ç»œ
      </a>
      
      <a
        href="https://aiyou.life/tag/jp41-NU1u/"
        class="badge success"
      >
        ReactNative
      </a>
      
      <a
        href="https://aiyou.life/tag/X7Cdzy-Hu/"
        class="badge secondary"
      >
        åšå®¢
      </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> |
    <a class="rss" href="https://aiyou.life/atom.xml" target="_blank"
      >RSS</a
    >
  </div>
</div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-core.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/prismjs@1.23.0/plugins/autoloader/prism-autoloader.min.js"></script>
<!-- <script src="//cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-bash.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-typescript.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-jsx.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/prismjs@1.23.0/components/prism-tsx.min.js"></script> -->
<script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">
  AOS.init()

  // hljs.initHighlightingOnLoad()
</script>

<script type="application/javascript">
  // ä¸€è¨€
  function oneWord(element) {
    if (!element) return
    const xhr = new XMLHttpRequest()
    xhr.open('get', 'https://v1.hitokoto.cn/')
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        element.innerText = JSON.parse(xhr.responseText).hitokoto
      }
    }
    xhr.send()
  }
  oneWord(document.querySelector('.text-muted'))
</script>

<script type="application/javascript">
  // åˆ†äº«
  var SimpleShare = function (options) {
    // get share content
    options = options || {}
    var url = options.url || window.location.href
    var title = options.title || document.title
    var content = options.content || ''
    var pic = options.pic || ''

    // fix content format
    url = encodeURIComponent(url)
    title = encodeURIComponent(title)
    content = encodeURIComponent(content)
    pic = encodeURIComponent(pic)

    // share target url
    var qzone =
      'http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url={url}&title={title}&pics={pic}&summary={content}'
    var weibo =
      'http://service.weibo.com/share/share.php?url={url}&title={title}&pic={pic}&searchPic=false'
    var tqq =
      'http://share.v.t.qq.com/index.php?c=share&a=index&url={url}&title={title}&appkey=801cf76d3cfc44ada52ec13114e84a96'
    var renren =
      'http://widget.renren.com/dialog/share?resourceUrl={url}&srcUrl={url}&title={title}&description={content}'
    var douban =
      'http://www.douban.com/share/service?href={url}&name={title}&text={content}&image={pic}'
    var facebook =
      'https://www.facebook.com/sharer/sharer.php?u={url}&t={title}&pic={pic}'
    var twitter = 'https://twitter.com/intent/tweet?text={title}&url={url}'
    var linkedin =
      'https://www.linkedin.com/shareArticle?title={title}&summary={content}&mini=true&url={url}&ro=true'
    var weixin = 'http://qr.topscan.com/api.php?text={url}'
    var qq =
      'http://connect.qq.com/widget/shareqq/index.html?url={url}&desc={title}&pics={pic}'

    // replace content functions
    function replaceAPI(api) {
      api = api.replace('{url}', url)
      api = api.replace('{title}', title)
      api = api.replace('{content}', content)
      api = api.replace('{pic}', pic)

      return api
    }

    // share target
    this.qzone = function () {
      window.open(replaceAPI(qzone))
    }
    this.weibo = function () {
      window.open(replaceAPI(weibo))
    }
    this.tqq = function () {
      window.open(replaceAPI(tqq))
    }
    this.renren = function () {
      window.open(replaceAPI(renren))
    }
    this.douban = function () {
      window.open(replaceAPI(douban))
    }
    this.facebook = function () {
      window.open(replaceAPI(facebook))
    }
    this.twitter = function () {
      window.open(replaceAPI(twitter))
    }
    this.linkedin = function () {
      window.open(replaceAPI(linkedin))
    }
    this.qq = function () {
      window.open(replaceAPI(qq))
    }
    this.weixin = function (callback) {
      if (!callback) {
        window.open(replaceAPI(weixin))
      } else {
        callback(replaceAPI(weixin))
      }
    }
  }
  var share = new SimpleShare()
</script>



<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: 'f9e29934c5621e13bb13',
    clientSecret: '6ca4b35e60834188ea98ca3be6fba3c21b5ad34a',
    repo: 'xdoer.github.io',
    owner: 'xdoer',
    admin: ['xdoer'],
    id: location.pathname.substring(0, 49), // Ensure uniqueness and length less than 50
    distractionFreeMode: false, // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')
</script>
  
<script>
  // ç‚¹å‡»æ–‡ç« å†…éƒ¨å›¾ç‰‡æŸ¥çœ‹å¤§å›¾
  const contentImagesEles = [...document.querySelectorAll('.post-content img')]
  const maskEle = document.querySelector('.prev-mask')
  const containerEle = document.querySelector('.image-container')
  const imgCloseEle = document.querySelector('.img-close')
  const imgBigEle = document.querySelector('.img-big')

  contentImagesEles.forEach((ele) => {
    ele.style

    ele.addEventListener('click', () => {
      const { currentSrc } = ele
      imgBigEle.src = currentSrc
      maskEle.style.display = 'flex'
    })
  })

  imgCloseEle.addEventListener('click', () => {
    maskEle.style.display = 'none'
  })
</script>

  </body>
</html>
