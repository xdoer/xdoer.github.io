<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" >

<title>ç”±å°è£…ä¸€ä¸ªè¯·æ±‚åº“æ‰€æƒ³åˆ°çš„ |
    æ–‡äº«æ—¥å¿—</title>
<meta name="description" content="">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<link rel="shortcut icon" href="https://aiyou.life/favicon.ico?v=1622616224380">

<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.2/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/papercss@1.6.1/dist/paper.min.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
<link rel="stylesheet" href="https://aiyou.life/styles/main.css">


  
    <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css" />
  

  

<script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>


<link rel="stylesheet" href="https://unpkg.com/aos@next/dist/aos.css" />


  </head>
  <body>
    <nav class="navbar border fixed split-nav">
  <div class="nav-brand">
    <h3><a href="https://aiyou.life">æ–‡äº«æ—¥å¿—</a></h3>
  </div>
  <div class="collapsible">
    <input id="collapsible1" type="checkbox" name="collapsible1">
    <button>
      <label for="collapsible1">
        <div class="bar1"></div>
        <div class="bar2"></div>
        <div class="bar3"></div>
      </label>
    </button>
    <div class="collapsible-body">
      <ul class="inline">
        
          <li>
            
              <a href="/" class="menu">
                é¦–é¡µ
              </a>
            
          </li>
        
          <li>
            
              <a href="/archives" class="menu">
                å½’æ¡£
              </a>
            
          </li>
        
          <li>
            
              <a href="/tags" class="menu">
                æ ‡ç­¾
              </a>
            
          </li>
        
          <li>
            
              <a href="/post/about" class="menu">
                å…³äº
              </a>
            
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div id="top" class="row site">
      <div class="sm-12 md-8 col">
        <div class="paper">
          <article class="article">
            <h1>ç”±å°è£…ä¸€ä¸ªè¯·æ±‚åº“æ‰€æƒ³åˆ°çš„</h1>
            <p class="article-meta">
              2021-05-06 
              <a
                href="https://aiyou.life/tag/K1r5vpFd_/"
                class="badge warning"
              >
                å‰ç«¯
              </a>
              
              <a
                href="https://aiyou.life/tag/g_6wyy_ol/"
                class="badge "
              >
                ç½‘ç»œ
              </a>
              
              <a
                href="https://aiyou.life/tag/E75leUW9b/"
                class="badge success"
              >
                typescript
              </a>
              
            </p>
            
            <img src="https://aiyou.life/post-images/M4RcI3wfU.png" alt="ç”±å°è£…ä¸€ä¸ªè¯·æ±‚åº“æ‰€æƒ³åˆ°çš„" />
            
            <div class="post-content"><p>æ˜¯å¦æœ‰ä¸€ç§æ–¹å¼ï¼Œä»åº•å‘ä¸Šçš„ï¼Œé’ˆå¯¹ä¸åŒçš„è¯·æ±‚å†…æ ¸å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¸ºå…¶èµ‹äºˆè¯·æ±‚åº“æ‹¦æˆªå™¨ã€ä¸­é—´ä»¶ã€å¿«æ·è¯·æ±‚ç­‰å‡ ä¸ªé€šç”¨åŠŸèƒ½ï¼Œå¹¶ä¸”ä¿ç•™ä¸åŒè¯·æ±‚å†…æ ¸çš„å·®å¼‚åŒ–ï¼Ÿ</p>
<!-- more -->
<h2 id="å‰è¨€">å‰è¨€</h2>
<p>æœ€è¿‘æƒ³å†™ä¸€ä¸ªå¯ä»¥é€‚é…å¤šå¹³å°çš„è¯·æ±‚åº“ï¼Œåœ¨ç ”ç©¶ xhr å’Œ fetch å‘ç°äºŒè€…çš„å‚æ•°ã€å“åº”ã€å›è°ƒå‡½æ•°ç­‰å·®åˆ«å¾ˆå¤§ã€‚æƒ³åˆ°å¦‚æœè¯·æ±‚åº“æƒ³è¦é€‚é…å¤šå¹³å°ï¼Œéœ€è¦ç»Ÿä¸€çš„ä¼ å‚å’Œå“åº”æ ¼å¼ï¼Œé‚£ä¹ˆåŠ¿å¿…ä¼šåœ¨è¯·æ±‚åº“å†…éƒ¨åšå¤§é‡çš„åˆ¤æ–­ï¼Œè¿™æ ·ä¸ä½†è´¹æ—¶è´¹åŠ›ï¼Œè¿˜ä¼šå±è”½æ‰åº•å±‚è¯·æ±‚å†…æ ¸å·®å¼‚ã€‚</p>
<p>é˜…è¯» axios å’Œ umi-request æºç æ—¶æƒ³åˆ°ï¼Œè¯·æ±‚åº“å…¶å®åŸºæœ¬éƒ½åŒ…å«äº†æ‹¦æˆªå™¨ã€ä¸­é—´ä»¶å’Œå¿«æ·è¯·æ±‚ç­‰å‡ ä¸ªé€šç”¨çš„ï¼Œä¸å…·ä½“è¯·æ±‚è¿‡ç¨‹æ— å…³çš„åŠŸèƒ½ã€‚ç„¶åé€šè¿‡ä¼ å‚ï¼Œè®©ç”¨æˆ·æ¥è§¦åº•å±‚è¯·æ±‚å†…æ ¸ã€‚é—®é¢˜åœ¨äºï¼Œè¯·æ±‚åº“å†…ç½®å¤šä¸ªåº•å±‚è¯·æ±‚å†…æ ¸ï¼Œå†…æ ¸æ”¯æŒçš„å‚æ•°æ˜¯ä¸ä¸€æ ·çš„ï¼Œä¸Šå±‚åº“å¯èƒ½åšä¸€äº›å¤„ç†ï¼ŒæŠ¹å¹³ä¸€äº›å‚æ•°çš„å·®å¼‚åŒ–ï¼Œä½†å¯¹äºåº•å±‚å†…æ ¸çš„ç‰¹æœ‰çš„åŠŸèƒ½ï¼Œè¦ä¹ˆæ”¾å¼ƒï¼Œè¦ä¹ˆåªèƒ½åœ¨å‚æ•°åˆ—è¡¨ä¸­åŠ å…¥ä¸€äº›å…·ä½“å†…æ ¸çš„ç‰¹æœ‰çš„å‚æ•°ã€‚æ¯”å¦‚åœ¨ axios ä¸­ï¼Œå®ƒçš„è¯·æ±‚é…ç½®å‚æ•°åˆ—è¡¨ä¸­ï¼Œç½—åˆ—äº†ä¸€äº› <a href="https://axios-http.com/docs/req_config">browser only</a>çš„å‚æ•°ï¼Œé‚£å¯¹äºåªéœ€è¦åœ¨ node ç¯å¢ƒä¸­è¿è¡Œçš„ axios æ¥è¯´ï¼Œå‚æ•°å¤šå°‘æœ‰äº›å†—ä½™ï¼Œå¹¶ä¸”å¦‚æœ axios è¦æ”¯æŒå…¶ä»–è¯·æ±‚å†…æ ¸(æ¯”å¦‚å°ç¨‹åºã€å¿«åº”ç”¨ã€åä¸ºé¸¿è’™ç­‰)ï¼Œé‚£ä¹ˆå‚æ•°å†—ä½™ä¹Ÿå°†è¶Šæ¥è¶Šå¤§ï¼Œæ‰©å±•æ€§ä¹Ÿå·®ã€‚</p>
<p>æ¢ä¸ªæ€è·¯æ¥æƒ³ï¼Œæ—¢ç„¶å®ç°ä¸€ä¸ªé€‚é…å¤šå¹³å°çš„ç»Ÿä¸€çš„è¯·æ±‚åº“æœ‰è¿™äº›é—®é¢˜ï¼Œé‚£ä¹ˆæ˜¯å¦å¯ä»¥ä»åº•å‘ä¸Šçš„ï¼Œé’ˆå¯¹ä¸åŒçš„è¯·æ±‚å†…æ ¸ï¼Œæä¾›ä¸€ç§æ–¹å¼å¯ä»¥å¾ˆæ–¹ä¾¿çš„ä¸ºå…¶èµ‹äºˆæ‹¦æˆªå™¨ã€ä¸­é—´ä»¶ã€å¿«æ·è¯·æ±‚ç­‰å‡ ä¸ªé€šç”¨åŠŸèƒ½ï¼Œå¹¶ä¸”ä¿ç•™ä¸åŒè¯·æ±‚å†…æ ¸çš„å·®å¼‚åŒ–ï¼Ÿ</p>
<h2 id="è®¾è®¡å®ç°">è®¾è®¡å®ç°</h2>
<p>æˆ‘ä»¬çš„è¯·æ±‚åº“è¦æƒ³ä¸è¯·æ±‚å†…æ ¸æ— å…³ï¼Œé‚£ä¹ˆåªèƒ½é‡‡ç”¨å†…æ ¸ä¸è¯·æ±‚åº“ç›¸åˆ†ç¦»çš„æ¨¡å¼ã€‚ä½¿ç”¨æ—¶ï¼Œéœ€è¦å°†è¯·æ±‚å†…æ ¸ä¼ å…¥ï¼Œåˆå§‹åŒ–ä¸€ä¸ªå®ä¾‹ï¼Œå†è¿›è¡Œä½¿ç”¨ã€‚æˆ–è€…åŸºäºè¯·æ±‚åº“ï¼Œä¼ å…¥å†…æ ¸ï¼Œé¢„ç½®è¯·æ±‚å‚æ•°æ¥è¿›è¡ŒäºŒæ¬¡å°è£…ã€‚</p>
<h3 id="åŸºæœ¬æ¶æ„">åŸºæœ¬æ¶æ„</h3>
<p>é¦–å…ˆå®ç°ä¸€ä¸ªåŸºæœ¬çš„æ¶æ„</p>
<pre><code class="language-ts">class PreQuest {
    constructor(private adapter)
    
    request(opt) {
        return this.adapter(opt)
    }
}

const adapter = (opt) =&gt; nativeRequestApi(opt)
// eg: const adapter = (opt) =&gt; fetch(opt).then(res =&gt; res.json())

// åˆ›å»ºå®ä¾‹
const prequest = new PreQuest(adapter)

// è¿™é‡Œå®é™…è°ƒç”¨çš„æ˜¯ adapter å‡½æ•°
prequest.request({ url: 'http://localhost:3000/api' })
</code></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œè¿™é‡Œé¥¶äº†ä¸ªå¼¯ï¼Œé€šè¿‡å®ä¾‹æ–¹æ³•è°ƒç”¨äº† adapter å‡½æ•°ã€‚</p>
<p>è¿™æ ·çš„è¯ï¼Œä¸ºä¿®æ”¹è¯·æ±‚å’Œå“åº”æä¾›äº†æƒ³è±¡ç©ºé—´ã€‚</p>
<pre><code class="language-ts">class PreQuest {
    // ...some code
    
    async request(opt){
        const options = modifyReqOpt(opt)
        const res = await this.adapter(options)
        return modifyRes(res)
    }

    // ...some code
}
</code></pre>
<h3 id="ä¸­é—´ä»¶">ä¸­é—´ä»¶</h3>
<p>å¯ä»¥é‡‡ç”¨ koa çš„æ´‹è‘±æ¨¡å‹ï¼Œå¯¹è¯·æ±‚è¿›è¡Œæ‹¦æˆªå’Œä¿®æ”¹ã€‚</p>
<p>ä¸­é—´ä»¶è°ƒç”¨ç¤ºä¾‹:</p>
<pre><code class="language-ts">const prequest = new PreQuest(adapter)

prequest.use(async (ctx, next) =&gt; {
    ctx.request.path = '/perfix' + ctx.request.path
    await next()
    ctx.response.body = JSON.parse(ctx.response.body)
})
</code></pre>
<p>å®ç°ä¸­é—´ä»¶åŸºæœ¬æ¨¡å‹ï¼Ÿ</p>
<pre><code class="language-ts">class Middleware {
    // ä¸­é—´ä»¶åˆ—è¡¨
    cbs = []
    
    // æ³¨å†Œä¸­é—´ä»¶
    use(cb) {
       this.cbs.push(cb)
       return this
    }
    
    // æ‰§è¡Œä¸­é—´ä»¶
    exec(ctx, next){

        let times = -1
    
        const dispatch = (pointer = 0): Promise&lt;any&gt; =&gt; {
            if (cbs.length &lt; pointer) return Promise.resolve()

            const fn = this.cbs[pointer] || next

            if (pointer &lt;= times) throw new Error('next function only can be called once')
             // ç¡®ä¿æ¯ä¸ªä¸­é—´ä»·ä¸­ next æ–¹æ³•åªè°ƒç”¨ä¸€æ¬¡
             times = pointer

            // æ´‹è‘±æ¨¡å‹
             return fn(ctx, () =&gt; dispatch(++pointer))
        }

        return dispatch()
    }
}
</code></pre>
<p>å…¨å±€ä¸­é—´ä»¶ï¼Œåªéœ€è¦æ·»åŠ ä¸€ä¸ª use å’Œ exec çš„é™æ€æ–¹æ³•å³å¯ã€‚</p>
<p>PreQuest ç»§æ‰¿è‡ª Middleware ç±»ï¼Œå³å¯åœ¨å®ä¾‹ä¸Šæ³¨å†Œä¸­é—´ä»¶ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆåœ¨è¯·æ±‚å‰è°ƒç”¨ä¸­é—´ä»¶?</p>
<pre><code class="language-ts">class PreQuest extends Middleware {
    // ...some code
     
    async request(opt) {
    
        const ctx = {
            request: opt,
            response: {}
        }
        
        // æ‰§è¡Œä¸­é—´ä»¶
        async this.exec(ctx, async (ctx) =&gt; {
            ctx.response = await this.adapter(ctx.request)
        })
        
        return ctx.response
    }
        
    // ...some code
}

</code></pre>
<p>ä¸­é—´ä»¶æ¨¡å‹ä¸­ï¼Œå‰ä¸€ä¸ªä¸­é—´ä»¶çš„è¿”å›å€¼æ˜¯ä¼ ä¸åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ä¸­ï¼Œæ‰€ä»¥æ˜¯é€šè¿‡ä¸€ä¸ªå¯¹è±¡åœ¨ä¸­é—´ä»¶ä¸­ä¼ é€’å’Œèµ‹å€¼ã€‚</p>
<h3 id="æ‹¦æˆªå™¨">æ‹¦æˆªå™¨</h3>
<p>æ‹¦æˆªå™¨æ˜¯ä¿®æ”¹å‚æ•°å’Œå“åº”çš„å¦ä¸€ç§æ–¹å¼ã€‚</p>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹ axios ä¸­æ‹¦æˆªå™¨æ˜¯æ€ä¹ˆç”¨çš„ã€‚</p>
<pre><code class="language-ts">import axios from 'axios'

const instance = axios.create()

instance.interceptor.request.use(
    (opt) =&gt; modifyOpt(opt),
    (e) =&gt; handleError(e)
)
</code></pre>
<p>æ ¹æ®ç”¨æ³•ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ªåŸºæœ¬ç»“æ„</p>
<pre><code class="language-ts">class Interceptor {
    cbs = []
    
    // æ³¨å†Œæ‹¦æˆªå™¨
    use(successHandler, errorHandler) {
        this.cbs.push({ successHandler, errorHandler })
    }
    
    exec(opt) {
      return this.cbs.reduce(
        (t, c, idx) =&gt; t.then(c.successHandler, this.handles[idx - 1]?.errorHandler),
        Promise.resolve(opt)
      )
      .catch(this.handles[this.handles.length - 1].errorHandler)
    }
}
</code></pre>
<p>ä»£ç å¾ˆç®€å•ï¼Œæœ‰ç‚¹éš¾åº¦çš„å°±æ˜¯æ‹¦æˆªå™¨çš„æ‰§è¡Œäº†ã€‚è¿™é‡Œä¸»è¦æœ‰ä¸¤ä¸ªçŸ¥è¯†ç‚¹: Array.reduce å’Œ Promise.then ç¬¬äºŒä¸ªå‚æ•°çš„ä½¿ç”¨ã€‚</p>
<p>æ³¨å†Œæ‹¦æˆªå™¨æ—¶ï¼Œ<code>successHandler</code> ä¸ <code>errorHandler</code> æ˜¯æˆå¯¹çš„ï¼Œ successHandler ä¸­æŠ›å‡ºçš„é”™è¯¯ï¼Œè¦åœ¨å¯¹åº”çš„ errorHandler ä¸­å¤„ç†ï¼Œæ‰€ä»¥ errorHandler æ¥æ”¶åˆ°çš„é”™è¯¯ï¼Œæ˜¯ä¸Šä¸€ä¸ªæ‹¦æˆªå™¨ä¸­æŠ›å‡ºçš„ã€‚</p>
<p>æ‹¦æˆªå™¨æ€ä¹ˆä½¿ç”¨å‘¢?</p>
<pre><code class="language-ts">class PreQuest {
    // ... some code
    interceptor = {
        request: new Interceptor()
        response: new Interceptor()
    }
    
    // ...some code
    
    async request(opt){
        
        // æ‰§è¡Œæ‹¦æˆªå™¨ï¼Œä¿®æ”¹è¯·æ±‚å‚æ•°
        const options = await this.interceptor.request.exec(opt)
        
        const res = await this.adapter(options)
        
        // æ‰§è¡Œæ‹¦æˆªå™¨ï¼Œä¿®æ”¹å“åº”æ•°æ®
        const response = await this.interceptor.response.exec(res)
        
        return response
    }
    
}
</code></pre>
<h3 id="æ‹¦æˆªå™¨ä¸­é—´ä»¶">æ‹¦æˆªå™¨ä¸­é—´ä»¶</h3>
<p>æ‹¦æˆªå™¨ä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªä¸­é—´ä»¶ï¼Œå¯ä»¥é€šè¿‡æ³¨å†Œä¸­é—´ä»¶æ¥å®ç°ã€‚è¯·æ±‚æ‹¦æˆªå™¨åœ¨ <code>await next()</code> å‰æ‰§è¡Œï¼Œå“åº”æ‹¦æˆªå™¨åœ¨å…¶åã€‚</p>
<pre><code class="language-ts">const instance = new Middleware()

instance.use(async (ctx, next) =&gt; {
    // Promise é“¾å¼è°ƒç”¨ï¼Œæ›´æ”¹è¯·æ±‚å‚æ•°
    await Promise.resolve().then(reqInterceptor1).then(reqInterceptor2)...
    // æ‰§è¡Œä¸‹ä¸€ä¸ªä¸­é—´ä»¶ã€æˆ–æ‰§è¡Œåˆ° this.adapter å‡½æ•°
    await next()
    // Promise é“¾å¼è°ƒç”¨ï¼Œæ›´æ”¹å“åº”æ•°æ®
    await Promise.resolve().then(resInterceptor1).then(resInterceptor2)...
})
</code></pre>
<p>æ‹¦æˆªå™¨æœ‰è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨ä¸¤ç±»ã€‚</p>
<pre><code class="language-ts">class InterceptorMiddleware {
    request = new Interceptor()
    response = new Interceptor()
    
    // æ³¨å†Œä¸­é—´ä»¶
    register: async (ctx, next) {
        ctx.request = await this.request.exec(ctx.request)
        await next()
        ctx.response = await thie.response.exec(ctx.response)
    }
}
</code></pre>
<p>ä½¿ç”¨</p>
<pre><code class="language-ts">const instance = new Middleware()
const interceptor = new InterceptorMiddleware()

// æ³¨å†Œæ‹¦æˆªå™¨
interceptor.request.use(
    (opt) =&gt; modifyOpt(opt),
    (e) =&gt; handleError(e)
)

// æ³¨å†Œåˆ°ä¸­é—´ä¸­
instance.use(interceptor.register)
</code></pre>
<h3 id="ç±»å‹è¯·æ±‚">ç±»å‹è¯·æ±‚</h3>
<p>è¿™é‡Œæˆ‘æŠŠç±»ä¼¼ <code>instance.get('/api')</code> è¿™æ ·çš„è¯·æ±‚å«åšç±»å‹è¯·æ±‚ã€‚åº“ä¸­é›†æˆç±»å‹è¯·æ±‚çš„è¯ï¼Œéš¾å…ä¼šå¯¹å¤–éƒ¨ä¼ å…¥çš„adapter å‡½æ•°çš„å‚æ•°è¿›è¡Œæ±¡æŸ“ã€‚å› ä¸ºéœ€è¦ä¸ºè¯·æ±‚æ–¹å¼ <code>get</code> å’Œè·¯å¾„ <code>/api</code> åˆ†é…é”®åï¼Œå¹¶ä¸”å°†å…¶æ··å…¥åˆ°å‚æ•°ä¸­ï¼Œé€šå¸¸åœ¨ä¸­é—´ä»¶ä¸­ä¼šæœ‰ä¿®æ”¹è·¯å¾„çš„éœ€æ±‚ã€‚</p>
<p>å®ç°å¾ˆç®€å•ï¼Œåªéœ€è¦éå† HTTP è¯·æ±‚ç±»å‹ï¼Œå¹¶å°†å…¶æŒ‚åœ¨ this ä¸‹å³å¯</p>
<pre><code class="language-ts">class PreQuest {
    constructor(private adapter) {
        this.mount()
    }
    
    // æŒ‚è½½æ‰€æœ‰ç±»å‹çš„åˆ«åè¯·æ±‚
    mount() {
       methods.forEach(method =&gt; {
           this[method] = (path, opt) =&gt; {
             // æ··å…¥ path å’Œ method å‚æ•°
             return this.request({ path, method, ...opt })
           }
       })
    }
    
    // ...some code

    request(opt) {
        // ...some code
    }
}

</code></pre>
<h3 id="ç®€å•è¯·æ±‚">ç®€å•è¯·æ±‚</h3>
<p>axios ä¸­ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™ç§å½¢å¼è¿›è¡Œè°ƒç”¨</p>
<pre><code class="language-ts">axios('http://localhost:3000/api').then(res =&gt; console.log(res))
</code></pre>
<p>æˆ‘å°†è¿™ç§è¯·æ±‚æ–¹å¼ç§°ä¹‹ä¸ºç®€å•è¯·æ±‚ã€‚</p>
<p>æˆ‘ä»¬è¿™é‡Œæ€ä¹ˆå®ç°è¿™ç§å†™æ³•çš„è¯·æ±‚æ–¹å¼å‘¢ï¼Ÿ</p>
<p>ä¸ä½¿ç”¨ class ï¼Œä½¿ç”¨ä¼ ç»Ÿå‡½æ•°ç±»å†™æ³•çš„è¯æ¯”è¾ƒå¥½å®ç°ï¼Œåªéœ€è¦åˆ¤æ–­å‡½æ•°æ˜¯å¦æ˜¯ new è°ƒç”¨ï¼Œç„¶ååœ¨å‡½æ•°å†…éƒ¨æ‰§è¡Œä¸åŒçš„é€»è¾‘å³å¯ã€‚</p>
<p>demo å¦‚ä¸‹</p>
<pre><code class="language-ts">function PreQuest() {
    if(!(this instanceof PreQuest)) {
        console.log('ä¸æ˜¯new è°ƒç”¨')
        return // ...some code
    }
   
   console.log('newè°ƒç”¨') 
   
   //... some code
}

// new è°ƒç”¨
const instance = new PreQuest(adapter)
instance.get('/api').then(res =&gt; console.log(res))

// ç®€å•è°ƒç”¨
PreQuest('/api').then(res =&gt; console.log(res))
</code></pre>
<p>class å†™æ³•çš„è¯ï¼Œä¸èƒ½è¿›è¡Œå‡½æ•°è°ƒç”¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ class å®ä¾‹ä¸Šåšæ–‡ç« ã€‚</p>
<p>é¦–å…ˆåˆå§‹åŒ–ä¸€ä¸ªå®ä¾‹ï¼Œçœ‹ä¸€ä¸‹ç”¨æ³•</p>
<pre><code class="language-ts">const prequest = new PreQuest(adapter)

prequest.get('http://localhost:3000/api')

prequest('http://localhost:3000/api')
</code></pre>
<p>é€šè¿‡ new å®ä¾‹åŒ–å‡ºæ¥çš„æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¯¹è±¡æ˜¯ä¸èƒ½å¤Ÿå½“åšå‡½æ•°æ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸èƒ½ç”¨ new çš„å½¢å¼æ¥åˆ›å»ºå¯¹è±¡ã€‚</p>
<p>å†çœ‹ä¸€ä¸‹ axios ä¸­ç”Ÿæˆå®ä¾‹çš„æ–¹æ³• <code>axios.create</code>, å¯ä»¥ä»ä¸­å¾—åˆ°çµæ„Ÿï¼Œå¦‚æœ <code>.create</code> æ–¹æ³•è¿”å›çš„æ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œå‡½æ•°ä¸ŠæŒ‚ä¸Šäº†æ‰€æœ‰ new å‡ºæ¥å¯¹è±¡ä¸Šçš„æ–¹æ³•ï¼Œè¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„éœ€æ±‚ã€‚</p>
<p>ç®€å•è®¾è®¡ä¸€ä¸‹:</p>
<p>æ–¹å¼ä¸€: æ‹·è´åŸå‹ä¸Šçš„æ–¹æ³•</p>
<pre><code class="language-ts">class PreQuest {

    static create(adapter) {
        const instance = new PreQuest(adapter)
        
        function inner(opt) {
           return instance.request(opt)
        }
        
        for(let key in instance) {
            inner[key] = instance[key]
        }
        
        return inner
    }
}
</code></pre>
<p><strong>æ³¨æ„: åœ¨æŸäº›ç‰ˆæœ¬çš„ es ä¸­ï¼Œ<code>for in</code> å¾ªç¯éå†ä¸å‡º class ç”Ÿæˆå®ä¾‹åŸå‹ä¸Šçš„æ–¹æ³•ã€‚</strong></p>
<p>æ–¹å¼äºŒ: è¿˜å¯ä»¥ä½¿ç”¨ Proxy ä»£ç†ä¸€ä¸ªç©ºå‡½æ•°ï¼Œæ¥åŠ«æŒè®¿é—®ã€‚</p>
<pre><code class="language-ts">class PreQuest {
    
    // ...some code

    static create(adapter) {
        const instance = new PreQuest(adapter)
       
        return new Proxy(function (){}, {
          get(_, name) {
            return Reflect.get(instance, name)
          },
          apply(_, __, args) {
            return Reflect.apply(instance.request, instance, args)
          },
        })
    }
}
</code></pre>
<p>ä¸Šé¢ä¸¤ç§æ–¹æ³•çš„ç¼ºç‚¹åœ¨äºï¼Œé€šè¿‡ <code>create</code> æ–¹æ³•è¿”å›çš„å°†ä¸å†æ˜¯ <code>PreQuest</code> çš„å®ä¾‹ï¼Œå³</p>
<pre><code class="language-ts">const prequest = PreQuest.create(adapter)

prequest instanceof PreQuest  // false
</code></pre>
<p>ä¸ªäººç›®å‰è¿˜æ²¡æœ‰æƒ³åˆ°ï¼Œåˆ¤æ–­ <code>prequest</code> æ˜¯ä¸æ˜¯ <code>PreQuest</code> å®ä¾‹æœ‰ä»€ä¹ˆç”¨ï¼Œå¹¶ä¸”ä¹Ÿæ²¡æœ‰æƒ³åˆ°å¥½çš„è§£å†³åŠæ³•ã€‚æœ‰è§£å†³æ–¹æ¡ˆçš„è¯·åœ¨è¯„è®ºé‡Œå‘Šè¯‰æˆ‘ã€‚</p>
<p>ä½¿ç”¨ <code>.create</code> åˆ›å»º 'å®ä¾‹' çš„æ–¹å¼å¯èƒ½ä¸ç¬¦åˆç›´è§‰ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥é€šè¿‡ Proxy åŠ«æŒ new æ“ä½œã€‚</p>
<p>Demoå¦‚ä¸‹:</p>
<pre><code class="language-ts">class InnerPreQuest {
  create() {
     // ...some code
  }
}

const PreQuest = new Proxy(InnerPreQuest, {
    construct(_, args) {
        return () =&gt; InnerPreQuest.create(...args)
    }
})
</code></pre>
<h3 id="è¯·æ±‚é”">è¯·æ±‚é”</h3>
<p>å¦‚ä½•å®ç°åœ¨è¯·æ±‚æ¥å£å‰ï¼Œå…ˆæ‹¿åˆ° token å†å»è¯·æ±‚ï¼Ÿ</p>
<p>ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œé¡µé¢åŒæ—¶å‘èµ·å¤šä¸ªè¯·æ±‚</p>
<pre><code class="language-ts">const prequest = PreQuest.create(adapter)

prequest('/api/1').catch(e =&gt; e)     // auth fail
prequest('/api/2').catch(e =&gt; e)    // auth fail
prequest('/api/3').catch(e =&gt; e)    // auth fail
</code></pre>
<p>é¦–å…ˆå¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸­é—´ä»¶ä¸ºå…¶æ·»åŠ  token</p>
<pre><code class="language-ts">prequest.use(async (ctx, next) =&gt; {
    ctx.request.headers['Authorization'] = `bearer ${token}`
    await next()
})
</code></pre>
<p>ä½† token å€¼ä»ä½•è€Œæ¥ï¼Ÿtoken éœ€è¦è¯·æ±‚æ¥å£å¾—æ¥ï¼Œå¹¶ä¸”éœ€è¦é‡æ–°åˆ›å»ºè¯·æ±‚å®ä¾‹ï¼Œä»¥é¿å…é‡æ–°èµ°æ·»åŠ  token çš„ä¸­é—´ä»¶çš„é€»è¾‘ã€‚</p>
<p>ç®€å•å®ç°ä¸€ä¸‹</p>
<pre><code class="language-ts">const tokenRequest = PreQuest.create(adapter)

let token = null
prequest.use(async (ctx, next) =&gt; {
    if(!token) {
        token = await tokenRequest('/token')
    }
    ctx.request.headers['Authorization'] = `bearer ${token}`
    await next()
})
</code></pre>
<p>è¿™é‡Œä½¿ç”¨äº† token å˜é‡ï¼Œæ¥é¿å…æ¯æ¬¡è¯·æ±‚æ¥å£ï¼Œéƒ½å»è°ƒæ¥å£æ‹¿ tokenã€‚</p>
<p>ä»£ç ä¹ä¸€çœ‹æ²¡æœ‰é—®é¢˜ï¼Œä½†ä»”ç»†ä¸€æƒ³ï¼Œå½“åŒæ—¶è¯·æ±‚å¤šä¸ªæ¥å£ï¼ŒtokenRequest è¯·æ±‚è¿˜æ²¡æœ‰å¾—åˆ°å“åº”æ—¶ï¼Œåé¢çš„è¯·æ±‚åˆéƒ½èµ°åˆ°è¿™ä¸ªä¸­é—´ä»¶ï¼Œæ­¤æ—¶ token å€¼ä¸ºç©ºï¼Œä¼šé€ æˆå¤šæ¬¡è°ƒç”¨ tokenRequestã€‚é‚£ä¹ˆå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Ÿ</p>
<p>å¾ˆå®¹æ˜“æƒ³åˆ°ï¼Œå¯ä»¥åŠ ä¸ªé”æœºåˆ¶æ¥å®ç°</p>
<pre><code class="language-ts">let token = null
let pending = false
prequest.use(async (ctx, next) =&gt; {
    if(!token) {
        if(pending) return
        pending = true
        token = await tokenRequest('/token')
        pending = flase
    }
    ctx.request.headers['Authorization'] = `bearer ${token}`
    await next()
})
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬åŠ äº† pending æ¥åˆ¤æ–­ tokenRequest çš„æ‰§è¡Œï¼ŒæˆåŠŸè§£å†³äº† tokenRequest æ‰§è¡Œå¤šæ¬¡çš„é—®é¢˜ï¼Œä½†åˆå¼•å…¥äº†æ–°çš„é—®é¢˜ï¼Œåœ¨æ‰§è¡Œ tokenRequest æ—¶ï¼Œåé¢åˆ°æ¥çš„è¯·æ±‚åº”å½“æ€ä¹ˆå¤„ç†ï¼Ÿä¸Šé¢çš„ä»£ç ï¼Œç›´æ¥ return æ‰äº†ï¼Œè¯·æ±‚å°†è¢«ä¸¢å¼ƒã€‚å®é™…ä¸Šï¼Œæˆ‘ä»¬å¸Œæœ›ï¼Œè¯·æ±‚å¯ä»¥åœ¨è¿™é‡Œæš‚åœï¼Œå½“æ‹¿åˆ° token æ—¶ï¼Œå†è¯·æ±‚åé¢çš„ä¸­é—´ä»¶ã€‚</p>
<p>æš‚åœï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å¾ˆå®¹æƒ³åˆ°ä½¿ç”¨ asyncã€await æˆ–è€… promise æ¥å®ç°ã€‚ä½†åœ¨è¿™é‡Œå¦‚ä½•ç”¨å‘¢ï¼Ÿ</p>
<p>æˆ‘ä» axios çš„ <a href="https://github.com/axios/axios/blob/e9965bfafc82d8b42765705061b9ebe2d5532493/lib/cancel/CancelToken.js#L17">cancelToken</a> å®ç°ä¸­å¾—åˆ°äº†çµæ„Ÿã€‚axios ä¸­ï¼Œåˆ©ç”¨ promise ç®€å•å®ç°äº†ä¸€ä¸ªçŠ¶æ€æœºï¼Œå°† Promise ä¸­çš„ resolve èµ‹å€¼åˆ°å¤–éƒ¨å±€éƒ¨å˜é‡ï¼Œå®ç°å¯¹ promise æµç¨‹çš„æ§åˆ¶ã€‚</p>
<p>ç®€å•å®ç°ä¸€ä¸‹</p>
<pre><code class="language-ts">let token = null
let pending = false
let resolvePromise
let promise = new Promise((resolve) =&gt; resolvePromise = resolve)

prequest.use(async (ctx, next) =&gt; {
    if(!token) {
        if(pending) {
            // promise æ§åˆ¶æµç¨‹
            token = await promise
        } else {
            pending = true
            token = await tokenRequest('/token')
            // è°ƒç”¨ resolveï¼Œä½¿å¾— promise å¯ä»¥æ‰§è¡Œå‰©ä½™çš„æµç¨‹
            resolvePromise(token)
            pending = flase
        }
    } 

    ctx.request.headers['Authorization'] = `bearer ${token}`
    await next()
})
</code></pre>
<p>å½“æ‰§è¡Œ tokenRequest æ—¶ï¼Œå…¶ä½™è¯·æ±‚çš„æ¥å£ï¼Œéƒ½ä¼šè¿›å…¥åˆ°ä¸€ä¸ª promise æ§åˆ¶çš„æµç¨‹ä¸­ï¼Œå½“ token å¾—åˆ°åï¼Œé€šè¿‡å¤–éƒ¨ resolve, æ§åˆ¶ promise ç»§ç»­æ‰§è¡Œï¼Œä»¥æ­¤è®¾ç½®è¯·æ±‚å¤´ï¼Œå’Œæ‰§è¡Œå‰©ä½™ä¸­é—´ä»¶ã€‚</p>
<p>è¿™ç§æ–¹å¼è™½ç„¶å®ç°äº†éœ€æ±‚ï¼Œä½†ä»£ç ä¸‘é™‹ä¸ç¾è§‚ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥å°†çŠ¶æ€éƒ½å°è£…åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ã€‚ä»¥å®ç°ç±»ä¼¼ä¸‹é¢è¿™ç§è°ƒç”¨ã€‚è¿™æ ·çš„è°ƒç”¨ç¬¦åˆç›´è§‰ä¸”ç¾è§‚ã€‚</p>
<pre><code class="language-ts">prequest.use(async (ctx, next) =&gt; {
  const token = await wrapper(tokenRequest)
  ctx.request.headers['Authorization'] = `bearer ${token}`
  await next()
})
</code></pre>
<p>æ€ä¹ˆå®ç°è¿™æ ·ä¸€ä¸ª wrapper å‡½æ•°ï¼Ÿ</p>
<p>é¦–å…ˆï¼ŒçŠ¶æ€ä¸èƒ½å°è£…åˆ° wrapper å‡½æ•°ä¸­ï¼Œå¦åˆ™æ¯æ¬¡éƒ½ä¼šç”Ÿæˆæ–°çš„çŠ¶æ€ï¼Œwrapper å°†å½¢åŒè™šè®¾ã€‚å¯ä»¥ä½¿ç”¨é—­åŒ…å‡½æ•°å°†çŠ¶æ€ä¿å­˜ã€‚</p>
<pre><code class="language-ts">function createWrapper() {
    let token = null
    let pending = false
    let resolvePromise
    let promise = new Promise((resolve) =&gt; resolvePromise = resolve)
    return function (fn) {
        if(pending) return promise
        if(token) return token

        pending = true

        token = await fn()

        pending = false
        resolvePromise(token)

        return token
    }
}
</code></pre>
<p>ä½¿ç”¨æ—¶ï¼Œåªéœ€è¦åˆ©ç”¨ <code>createWrapper</code> ç”Ÿæˆä¸€ä¸ª <code>wrapper</code> å³å¯</p>
<pre><code class="language-ts">const wrapper = createWrapper()

prequest.use(async (ctx, next) =&gt; {
  const token = await wrapper(tokenRequest)
  ctx.request.headers['Authorization'] = `bearer ${token}`
  await next()
})
</code></pre>
<p>è¿™æ ·çš„è¯ï¼Œå°±å¯ä»¥å®ç°æˆ‘ä»¬çš„ç›®çš„ã€‚</p>
<p>ä½†ï¼Œè¿™é‡Œçš„ä»£ç è¿˜æœ‰é—®é¢˜ï¼ŒçŠ¶æ€å°è£…åœ¨ createWrapper å†…éƒ¨ï¼Œå½“ token å¤±æ•ˆåï¼Œæˆ‘ä»¬å°†æ— ä»å¤„ç†ã€‚</p>
<p>æ¯”è¾ƒå¥½çš„åšæ³•æ˜¯ï¼Œå°†çŠ¶æ€ä» <code>createWrapper</code> å‚æ•°ä¸­ä¼ å…¥ã€‚</p>
<p>ä»£ç å®ç°ï¼Œè¯·å‚è€ƒ<a href="https://github.com/xdoer/PreQuest/blob/104c178e7c3a1b8edd8c6d36ad603e880297eba2/packages/lock/src/index.ts#L5">è¿™é‡Œ</a></p>
<h2 id="å®æˆ˜">å®æˆ˜</h2>
<p>ä»¥å¾®ä¿¡å°ç¨‹åºä¸ºä¾‹ã€‚å°ç¨‹åºä¸­è‡ªå¸¦çš„ <code>wx.request</code> å¹¶ä¸å¥½ç”¨ã€‚ä½¿ç”¨ä¸Šé¢æˆ‘ä»¬å°è£…çš„ä»£ç ï¼Œå¯ä»¥å¾ˆå®¹æ˜“çš„æ‰“é€ å‡ºä¸€ä¸ªå°ç¨‹åºè¯·æ±‚åº“ã€‚</p>
<h3 id="å°è£…å°ç¨‹åºåŸç”Ÿè¯·æ±‚">å°è£…å°ç¨‹åºåŸç”Ÿè¯·æ±‚</h3>
<p>å°†åŸç”Ÿå°ç¨‹åºè¯·æ±‚ Promise åŒ–ï¼Œè®¾è®¡ä¼ å‚ opt å¯¹è±¡</p>
<pre><code class="language-ts">function adapter(opt) {
  const { path, method, baseURL, ...options } = opt
  const url = baseURL + path
  return new Promise((resolve, reject) =&gt; {
    wx.request({
      ...options,
      url,
      method,
      success: resolve,
      fail: reject,
    })
  })
}

</code></pre>
<h3 id="è°ƒç”¨">è°ƒç”¨</h3>
<pre><code class="language-ts">const instance = PreQuest.create(adapter)

// ä¸­é—´ä»¶æ¨¡å¼
instance.use(async (ctx, next) =&gt; {
    // ä¿®æ”¹è¯·æ±‚å‚æ•°
    ctx.request.path = '/prefix' + ctx.request.path
    
    await next()
    
    // ä¿®æ”¹å“åº”
    ctx.response.body = JSON.parse(ctx.response.body)
})

// æ‹¦æˆªå™¨æ¨¡å¼
instance.interecptor.request.use(
    (opt) =&gt; {
        opt.path = '/prefix' + opt.path
        return opt
    }
)

instance.request({ path: '/api', baseURL: 'http://localhost:3000' })

instance.get('http://localhost:3000/api')

instance.post('/api', { baseURL: 'http://loclahost:3000' })
</code></pre>
<h3 id="è·å–åŸç”Ÿè¯·æ±‚å®ä¾‹">è·å–åŸç”Ÿè¯·æ±‚å®ä¾‹</h3>
<p>é¦–å…ˆçœ‹ä¸€ä¸‹åœ¨å°ç¨‹åºä¸­æ€æ ·ä¸­æ–­è¯·æ±‚</p>
<pre><code class="language-ts">const request = wx.request({
    // ...some code
})

request.abort()
</code></pre>
<p>ä½¿ç”¨æˆ‘ä»¬å°è£…çš„è¿™ä¸€å±‚ï¼Œå°†æ‹¿ä¸åˆ°åŸç”Ÿè¯·æ±‚å®ä¾‹ã€‚</p>
<p>é‚£ä¹ˆæ€ä¹ˆåŠå‘¢ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»ä¼ å‚ä¸­å…¥æ‰‹</p>
<pre><code class="language-ts">function adapter(opt) {
    const { getNativeRequestInstance } = opt
    
    let resolvePromise: any
    getNativeRequestInstance(new Promise(resolve =&gt; (resolvePromise = resolve)))
    
    return new Promise(() =&gt; {
        const nativeInstance = wx.request(
           // some code
        )
        
        resolvePromise(nativeInstance)
    })
}
</code></pre>
<p>ç”¨æ³•å¦‚ä¸‹:</p>
<pre><code class="language-ts">const instance = PreQuest.create(adapter)

instance.post('http://localhost:3000/api', {
    getNativeRequestInstance(promise) {
      promise.then(instance =&gt; {
          instance.abort()
      })
    }
})
</code></pre>
<p>éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå› ä¸º <code>wx.request</code> çš„æ‰§è¡Œæ˜¯åœ¨ n ä¸ªä¸­é—´ä»¶ã€æ‹¦æˆªå™¨ä¹‹åæ‰§è¡Œçš„ï¼Œé‡Œé¢å­˜åœ¨å¤§é‡å¼‚æ­¥ä»»åŠ¡ï¼Œæ‰€ä»¥é€šè¿‡ä¸Šé¢æ‹¿åˆ°çš„ <code>instance</code> åªèƒ½åœ¨å¼‚æ­¥ä¸­æ‰§è¡Œã€‚</p>
<h3 id="å…¼å®¹å¤šå¹³å°å°ç¨‹åº">å…¼å®¹å¤šå¹³å°å°ç¨‹åº</h3>
<p>æŸ¥çœ‹äº†å‡ ä¸ªå°ç¨‹åºå¹³å°å’Œå¿«åº”ç”¨ï¼Œå‘ç°è¯·æ±‚æ–¹å¼éƒ½æ˜¯å°ç¨‹åºçš„é‚£ä¸€å¥—ï¼Œé‚£å…¶å®æˆ‘ä»¬å®Œå…¨å¯ä»¥å°† <code>wx.request</code> æ‹¿å‡ºæ¥ï¼Œåˆ›å»ºå®ä¾‹çš„æ—¶å€™å†ä¼ è¿›å»ã€‚</p>
<h2 id="ç»“è¯­">ç»“è¯­</h2>
<p>ä¸Šé¢çš„å†…å®¹ä¸­ï¼Œæˆ‘ä»¬åŸºæœ¬å®ç°äº†ä¸€ä¸ªä¸è¯·æ±‚å†…æ ¸æ— å…³çš„è¯·æ±‚åº“ï¼Œå¹¶ä¸”è®¾è®¡äº†ä¸¤ç§æ‹¦æˆªè¯·æ±‚å’Œå“åº”çš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®è‡ªå·±çš„éœ€æ±‚å’Œå–œå¥½è‡ªç”±é€‰æ‹©ã€‚</p>
<p>è¿™ç§å†…æ ¸è£…å¸çš„æ–¹å¼éå¸¸å®¹æ˜“æ‰©å±•ã€‚å½“é¢å¯¹ä¸€ä¸ª axios ä¸æ”¯æŒçš„å¹³å°æ—¶ï¼Œä¹Ÿä¸ç”¨è´¹åŠ²çš„å»æ‰¾å¼€æºå¥½ç”¨çš„è¯·æ±‚åº“äº†ã€‚æˆ‘ç›¸ä¿¡å¾ˆå¤šäººåœ¨å¼€å‘å°ç¨‹åºçš„æ—¶å€™ï¼ŒåŸºæœ¬éƒ½æœ‰å»æ‰¾ axios-miniprogram çš„è§£å†³æ–¹æ¡ˆã€‚é€šè¿‡æˆ‘ä»¬çš„ PreQuest é¡¹ç›®ï¼Œå¯ä»¥ä½“éªŒåˆ°ç±»ä¼¼ axios çš„èƒ½åŠ›ã€‚</p>
<p><a href="https://github.com/xdoer/PreQuest">PreQuest</a> é¡¹ç›®ä¸­ï¼Œé™¤äº†ä¸Šé¢æåˆ°çš„å†…å®¹ï¼Œè¿˜æä¾›äº†å…¨å±€é…ç½®ã€å…¨å±€ä¸­é—´ä»¶ã€åˆ«åè¯·æ±‚ç­‰åŠŸèƒ½ã€‚é¡¹ç›®ä¸­ä¹Ÿæœ‰åŸºäº <code>PreQuest</code> å°è£…çš„è¯·æ±‚åº“ï¼Œ<a href="https://github.com/xdoer/PreQuest/tree/main/packages/miniprogram">@prequest/miniprogram</a>,<a href="https://github.com/xdoer/PreQuest/tree/main/packages/fetch">@prequest/fetch</a>...ä¹Ÿé’ˆå¯¹ä¸€äº›ä½¿ç”¨åŸç”Ÿ xhrã€fetch ç­‰ API çš„é¡¹ç›®ï¼Œæä¾›äº†ä¸€ç§ä¸ä¾µå…¥çš„æ–¹å¼æ¥èµ‹äºˆ PreQuestçš„èƒ½åŠ› <a href="https://github.com/xdoer/PreQuest/tree/main/packages/wrapper">@prequest/wrapper</a></p>
<h2 id="å‚è€ƒ">å‚è€ƒ</h2>
<p><a href="https://github.com/axios/axios">axios</a>: https://github.com/axios/axios</p>
<p><a href="https://github.com/umijs/umi-request">umi-request</a>:https://github.com/umijs/umi-request</p>
</div>
          </article>
          <div class="simple-share">
            <a class="share-item" href="javascript:share.qzone()">QQç©ºé—´</a>
            <a class="share-item" href="javascript:share.weibo()">å¾®åš</a>
            <a class="share-item" href="javascript:share.facebook()"
              >Facebook</a
            >
            <a class="share-item" href="javascript:share.twitter()">Twitter</a>
          </div>
        </div>
        <div class="paper" data-aos="fade-in">
          
          <div class="next-post">
            <div class="next">
              ä¸‹ä¸€ç¯‡
            </div>
            <a href="https://aiyou.life/post/ZSut5c_dE/">
              <h3 class="post-title">Fower: ä¸€ä¸ªå¤šå¹³å°åŸå­ç±» CSS In JS æ ·å¼åº“</h3>
            </a>
          </div>
          
        </div>
         
        <div class="paper" data-aos="fade-in">
          <div id="gitalk-container"></div>
        </div>
          
      </div>

      <div class="sm-12 md-4 col sidebar">
  <div class="paper info-container">
    <img
      src="https://aiyou.life/images/avatar.png?v=1622616224380"
      class="no-responsive avatar"
    />
    <div class="text-muted"></div>
    <div class="social-container">
       
      <a href="https://github.com/xdoer" target="_blank">
        <i class="fab fa-github"></i>
      </a>
        
      <a href="https://twitter.com/xxdoer1" target="_blank">
        <i class="fab fa-twitter"></i>
      </a>
        
      <a href="https://weibo.com/u/7407806835" target="_blank">
        <i class="fab fa-weibo"></i>
      </a>
          
      <a href="https://www.facebook.com/xxdoer" target="_blank">
        <i class="fab fa-facebook"></i>
      </a>
       
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      æœ€æ–°æ–‡ç« 
    </div>
    <div class="row">
      <ul>
         
        <li>
          <a href="https://aiyou.life/post/iWhkaOqqO/">å†™ä¸€ä¸ªå€’è®¡æ—¶ğŸ˜¢ï¼Ÿ</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/4XYWTWTx/">æƒ³åˆ°çš„ä¸€äº›å¾ˆå¥½çš„é¢è¯•é¢˜</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/M4RcI3wfU/">ç”±å°è£…ä¸€ä¸ªè¯·æ±‚åº“æ‰€æƒ³åˆ°çš„</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/ZSut5c_dE/">Fower: ä¸€ä¸ªå¤šå¹³å°åŸå­ç±» CSS In JS æ ·å¼åº“</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/FkN_iGcYQ/">Taroå°ç¨‹åºå¼€å‘æå‡æ•ˆç‡çš„å‡ ç‚¹åˆ†äº«-è·¯ç”±ç¯‡</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/FEu-GtOkz/">ReactNativeæ¸è¿›å¼å›¾ç‰‡åŠ è½½</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/qo35dDzbQ/">å¤šè¡Œæ–‡æœ¬æº¢å‡ºçœç•¥</a>
        </li>
          
        <li>
          <a href="https://aiyou.life/post/-d73T0KeE/">TSå­¦ä¹ ç¬”è®°</a>
        </li>
                         
      </ul>
    </div>
  </div>
  <div class="paper">
    <div class="sidebar-title">
      æ ‡ç­¾åˆ—è¡¨
    </div>
    <div class="row">
      
      <a
        href="https://aiyou.life/tag/K1r5vpFd_/"
        class="badge success"
      >
        å‰ç«¯
      </a>
      
      <a
        href="https://aiyou.life/tag/TDgBvCzI8/"
        class="badge success"
      >
        javascript
      </a>
      
      <a
        href="https://aiyou.life/tag/g_6wyy_ol/"
        class="badge "
      >
        ç½‘ç»œ
      </a>
      
      <a
        href="https://aiyou.life/tag/E75leUW9b/"
        class="badge "
      >
        typescript
      </a>
      
      <a
        href="https://aiyou.life/tag/rSf0tu2pz/"
        class="badge "
      >
        React
      </a>
      
      <a
        href="https://aiyou.life/tag/jp41-NU1u/"
        class="badge success"
      >
        ReactNative
      </a>
      
      <a
        href="https://aiyou.life/tag/TfrzxMzWY/"
        class="badge secondary"
      >
        å°ç¨‹åº
      </a>
      
      <a
        href="https://aiyou.life/tag/X7Cdzy-Hu/"
        class="badge secondary"
      >
        åšå®¢
      </a>
      
    </div>
  </div>
  <div class="paper">
    Powered by <a href="https://github.com/getgridea/gridea" target="_blank">Gridea</a> |
    <a class="rss" href="https://aiyou.life/atom.xml" target="_blank"
      >RSS</a
    >
  </div>
</div>

    </div>

    <script src="https://unpkg.com/aos@next/dist/aos.js"></script>

<script type="application/javascript">
  AOS.init()

  hljs.initHighlightingOnLoad()
</script>

<script type="application/javascript">
  // ä¸€è¨€
  function oneWord(element) {
    if (!element) return
    const xhr = new XMLHttpRequest()
    xhr.open('get', 'https://v1.hitokoto.cn/')
    xhr.onreadystatechange = function () {
      if (xhr.readyState === 4) {
        element.innerText = JSON.parse(xhr.responseText).hitokoto
      }
    }
    xhr.send()
  }
  oneWord(document.querySelector('.text-muted'))
</script>

<script type="application/javascript">
  // åˆ†äº«
  var SimpleShare = function (options) {
    // get share content
    options = options || {}
    var url = options.url || window.location.href
    var title = options.title || document.title
    var content = options.content || ''
    var pic = options.pic || ''

    // fix content format
    url = encodeURIComponent(url)
    title = encodeURIComponent(title)
    content = encodeURIComponent(content)
    pic = encodeURIComponent(pic)

    // share target url
    var qzone =
      'http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url={url}&title={title}&pics={pic}&summary={content}'
    var weibo =
      'http://service.weibo.com/share/share.php?url={url}&title={title}&pic={pic}&searchPic=false'
    var tqq =
      'http://share.v.t.qq.com/index.php?c=share&a=index&url={url}&title={title}&appkey=801cf76d3cfc44ada52ec13114e84a96'
    var renren =
      'http://widget.renren.com/dialog/share?resourceUrl={url}&srcUrl={url}&title={title}&description={content}'
    var douban =
      'http://www.douban.com/share/service?href={url}&name={title}&text={content}&image={pic}'
    var facebook =
      'https://www.facebook.com/sharer/sharer.php?u={url}&t={title}&pic={pic}'
    var twitter = 'https://twitter.com/intent/tweet?text={title}&url={url}'
    var linkedin =
      'https://www.linkedin.com/shareArticle?title={title}&summary={content}&mini=true&url={url}&ro=true'
    var weixin = 'http://qr.topscan.com/api.php?text={url}'
    var qq =
      'http://connect.qq.com/widget/shareqq/index.html?url={url}&desc={title}&pics={pic}'

    // replace content functions
    function replaceAPI(api) {
      api = api.replace('{url}', url)
      api = api.replace('{title}', title)
      api = api.replace('{content}', content)
      api = api.replace('{pic}', pic)

      return api
    }

    // share target
    this.qzone = function () {
      window.open(replaceAPI(qzone))
    }
    this.weibo = function () {
      window.open(replaceAPI(weibo))
    }
    this.tqq = function () {
      window.open(replaceAPI(tqq))
    }
    this.renren = function () {
      window.open(replaceAPI(renren))
    }
    this.douban = function () {
      window.open(replaceAPI(douban))
    }
    this.facebook = function () {
      window.open(replaceAPI(facebook))
    }
    this.twitter = function () {
      window.open(replaceAPI(twitter))
    }
    this.linkedin = function () {
      window.open(replaceAPI(linkedin))
    }
    this.qq = function () {
      window.open(replaceAPI(qq))
    }
    this.weixin = function (callback) {
      if (!callback) {
        window.open(replaceAPI(weixin))
      } else {
        callback(replaceAPI(weixin))
      }
    }
  }
  var share = new SimpleShare()
</script>



<script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<script>
  var gitalk = new Gitalk({
    clientID: 'f9e29934c5621e13bb13',
    clientSecret: '6ca4b35e60834188ea98ca3be6fba3c21b5ad34a',
    repo: 'xdoer.github.io',
    owner: 'xdoer',
    admin: ['xdoer'],
    id: location.pathname.substring(0, 49), // Ensure uniqueness and length less than 50
    distractionFreeMode: false, // Facebook-like distraction free mode
  })

  gitalk.render('gitalk-container')
</script>
  
<script>
  // ç‚¹å‡»æ–‡ç« å†…éƒ¨å›¾ç‰‡æŸ¥çœ‹å¤§å›¾
  const contentImagesEles = [...document.querySelectorAll('.post-content img')]
  const maskEle = document.querySelector('prev-mask')
  const containerEle = document.querySelector('image-container')
  const imgCloseEle = document.querySelector('img-close')
  const imgBigEle = document.querySelector('img-big')

  contentImagesEles.forEach((ele) => {
    ele.addEventListener('click', () => {
      const { currentSrc } = ele
      imgBigEle.attributes.currentSrc = currentSrc
      mask.style.display = 'block'
    })
  })

  imgCloseEle.addEventListener('click', () => {
    mask.style.display = 'none'
  })
</script>

  </body>
</html>
